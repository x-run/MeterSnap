{% extends "base.html" %}
{% block title %} - 読み取り{% endblock %}
{% block content %}
<a href="/" class="back">&larr; 戻る</a>

<section class="card">
  <h2>メーターを選択</h2>
  <select id="meterSel" class="select-full">
    <option value="">-- 選択してください --</option>
    {% for m in meters %}
    <option value="{{ m.id }}">{{ m.name }} ({{ m.unit }})</option>
    {% endfor %}
  </select>
  {% if not meters %}
  <p class="empty">メーターが登録されていません。<a href="/meters/new">先に登録</a>してください。</p>
  {% endif %}
</section>

<section class="card" id="captureSection" style="display:none">
  <h2>メーター画像を撮影</h2>
  <label for="imgInput" class="btn btn-primary btn-block">撮影 / 画像を選択</label>
  <input type="file" id="imgInput" accept="image/*" capture="environment" hidden>
  <div id="preview" class="preview hidden">
    <img id="previewImg">
  </div>
</section>

<div id="loading" class="card hidden">
  <div class="loading">
    <div class="spinner"></div>
    <p>針を検出中…</p>
  </div>
</div>

<div id="result" class="hidden"></div>

<section class="card" id="retrySection" style="display:none">
  <button class="btn btn-outline btn-block" onclick="reset()">もう一度読み取る</button>
</section>

<script>
const $ = id => document.getElementById(id);

$('meterSel').onchange = function() {
  $('captureSection').style.display = this.value ? '' : 'none';
  $('result').innerHTML = '';
  $('result').className = 'hidden';
  $('retrySection').style.display = 'none';
  $('preview').classList.add('hidden');
};

$('imgInput').onchange = async function() {
  const f = this.files[0];
  if (!f) return;

  // preview
  const url = URL.createObjectURL(f);
  $('previewImg').src = url;
  $('preview').classList.remove('hidden');

  // send
  $('loading').classList.remove('hidden');
  $('result').innerHTML = '';
  $('result').className = 'hidden';

  const fd = new FormData();
  fd.append('image', f);
  fd.append('meter_id', $('meterSel').value);

  try {
    const r = await fetch('/api/read', { method: 'POST', body: fd });
    const d = await r.json();
    $('loading').classList.add('hidden');

    if (d.success) {
      $('result').className = 'result-card success';
      $('result').innerHTML = `
        <div class="result-value">${d.value}<span class="result-unit">${d.unit}</span></div>
        <div class="result-meta">${d.meter_name} / 検出角度: ${d.angle}°</div>
        <div class="result-saved">CSV に保存しました</div>`;
    } else {
      $('result').className = 'result-card error';
      $('result').innerHTML = `<div class="result-error">${d.error}</div>`;
    }
    $('retrySection').style.display = '';
  } catch (e) {
    $('loading').classList.add('hidden');
    $('result').className = 'result-card error';
    $('result').innerHTML = `<div class="result-error">通信エラーが発生しました</div>`;
    $('retrySection').style.display = '';
  }
};

function reset() {
  $('imgInput').value = '';
  $('preview').classList.add('hidden');
  $('result').innerHTML = '';
  $('result').className = 'hidden';
  $('retrySection').style.display = 'none';
  $('loading').classList.add('hidden');
}
</script>
{% endblock %}
